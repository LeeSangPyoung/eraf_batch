<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tes.batch.scheduler.domain.user.mapper.UserMapper">

    <!-- Result Map -->
    <resultMap id="UserResultMap" type="com.tes.batch.scheduler.domain.user.vo.UserVO">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="userType" column="user_type"/>
        <result property="userStatus" column="user_status"/>
        <result property="userPwd" column="user_pwd"/>
        <result property="celpTlno" column="celp_tlno"/>
        <result property="emailAddr" column="email_addr"/>
        <result property="loginFailCount" column="lgin_fail_ncnt"/>
        <result property="lastPwdChgDate" column="last_pwd_chg_date"/>
        <result property="lastLoginTime" column="last_lgin_timr"/>
        <result property="frstRegDate" column="frst_reg_date"/>
        <result property="lastChgDate" column="last_chg_date"/>
        <result property="lastActivityTime" column="last_activity_time"/>
    </resultMap>

    <!-- Base Column List -->
    <sql id="BaseColumns">
        id, user_id, user_name, user_type, user_status, user_pwd,
        celp_tlno, email_addr, lgin_fail_ncnt, last_pwd_chg_date,
        last_lgin_timr, frst_reg_date, last_chg_date, last_activity_time
    </sql>

    <!-- Find by ID -->
    <select id="findById" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_users
        WHERE id = #{id}
    </select>

    <!-- Find by User ID (login ID) -->
    <select id="findByUserId" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_users
        WHERE user_id = #{userId}
    </select>

    <!-- Find by User ID with Groups -->
    <select id="findByUserIdWithGroups" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_users
        WHERE user_id = #{userId}
    </select>

    <!-- Check if User ID exists -->
    <select id="existsByUserId" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM scheduler_users WHERE user_id = #{userId}
        )
    </select>

    <!-- Find All Users -->
    <select id="findAll" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_users
        ORDER BY user_name ASC
    </select>

    <!-- Find Users with Filters -->
    <select id="findByFilters" resultMap="UserResultMap">
        SELECT DISTINCT u.id, u.user_id, u.user_name, u.user_type, u.user_status, u.user_pwd,
               u.celp_tlno, u.email_addr, u.lgin_fail_ncnt, u.last_pwd_chg_date,
               u.last_lgin_timr, u.frst_reg_date, u.last_chg_date, u.last_activity_time
        FROM scheduler_users u
        <if test="groupId != null">
            INNER JOIN scheduler_related_group_user rgu ON u.id = rgu.user_id
        </if>
        <where>
            <if test="textSearch != null and textSearch != ''">
                AND (
                    LOWER(u.user_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                    OR LOWER(u.user_id) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                )
            </if>
            <if test="userStatus != null">
                AND u.user_status = #{userStatus}
            </if>
            <if test="groupId != null">
                AND rgu.group_id = #{groupId}
            </if>
        </where>
        ORDER BY u.user_name ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count Users with Filters -->
    <select id="countByFilters" resultType="long">
        SELECT COUNT(DISTINCT u.id)
        FROM scheduler_users u
        <if test="groupId != null">
            INNER JOIN scheduler_related_group_user rgu ON u.id = rgu.user_id
        </if>
        <where>
            <if test="textSearch != null and textSearch != ''">
                AND (
                    LOWER(u.user_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                    OR LOWER(u.user_id) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                )
            </if>
            <if test="userStatus != null">
                AND u.user_status = #{userStatus}
            </if>
            <if test="groupId != null">
                AND rgu.group_id = #{groupId}
            </if>
        </where>
    </select>

    <!-- Find Users by Related Group IDs -->
    <select id="findByRelatedGroupIds" resultMap="UserResultMap">
        SELECT DISTINCT u.id, u.user_id, u.user_name, u.user_type, u.user_status, u.user_pwd,
               u.celp_tlno, u.email_addr, u.lgin_fail_ncnt, u.last_pwd_chg_date,
               u.last_lgin_timr, u.frst_reg_date, u.last_chg_date, u.last_activity_time
        FROM scheduler_users u
        INNER JOIN scheduler_related_group_user rgu ON u.id = rgu.user_id
        WHERE rgu.group_id IN
        <foreach collection="groupIds" item="groupId" open="(" separator="," close=")">
            #{groupId}
        </foreach>
        ORDER BY u.user_name ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Insert User -->
    <insert id="insert">
        INSERT INTO scheduler_users (
            id, user_id, user_name, user_type, user_status, user_pwd,
            celp_tlno, email_addr, lgin_fail_ncnt, last_pwd_chg_date,
            last_lgin_timr, frst_reg_date, last_chg_date, last_activity_time
        ) VALUES (
            #{id}, #{userId}, #{userName}, #{userType}, #{userStatus}, #{userPwd},
            #{celpTlno}, #{emailAddr}, #{loginFailCount}, #{lastPwdChgDate},
            #{lastLoginTime}, #{frstRegDate}, #{lastChgDate}, #{lastActivityTime}
        )
    </insert>

    <!-- Update User -->
    <update id="update">
        UPDATE scheduler_users
        SET user_name = #{userName},
            user_type = #{userType},
            user_status = #{userStatus},
            celp_tlno = #{celpTlno},
            email_addr = #{emailAddr},
            last_chg_date = #{lastChgDate}
        WHERE id = #{id}
    </update>

    <!-- Update Password -->
    <update id="updatePassword">
        UPDATE scheduler_users
        SET user_pwd = #{userPwd},
            last_pwd_chg_date = #{lastPwdChgDate},
            last_chg_date = #{lastPwdChgDate}
        WHERE id = #{id}
    </update>

    <!-- Update Login Success -->
    <update id="updateLoginSuccess">
        UPDATE scheduler_users
        SET last_lgin_timr = #{lastLoginTime},
            lgin_fail_ncnt = 0,
            last_activity_time = #{lastLoginTime}
        WHERE id = #{id}
    </update>

    <!-- Increment Login Fail Count -->
    <update id="incrementLoginFailCount">
        UPDATE scheduler_users
        SET lgin_fail_ncnt = lgin_fail_ncnt + 1
        WHERE id = #{id}
    </update>

    <!-- Update User Status -->
    <update id="updateStatus">
        UPDATE scheduler_users
        SET user_status = #{userStatus},
            last_chg_date = EXTRACT(EPOCH FROM NOW()) * 1000
        WHERE id = #{id}
    </update>

    <!-- Update Last Activity Time -->
    <update id="updateLastActivityTime">
        UPDATE scheduler_users
        SET last_activity_time = #{lastActivityTime}
        WHERE id = #{id}
    </update>

    <!-- Delete User -->
    <delete id="delete">
        DELETE FROM scheduler_users WHERE id = #{id}
    </delete>

    <!-- Insert User-Group Relation -->
    <insert id="insertUserGroup">
        INSERT INTO scheduler_related_group_user (id, user_id, group_id)
        VALUES (#{id}, #{userId}, #{groupId})
    </insert>

    <!-- Delete User-Group Relations -->
    <delete id="deleteUserGroups">
        DELETE FROM scheduler_related_group_user WHERE user_id = #{userId}
    </delete>

    <!-- Find Related Group IDs -->
    <select id="findRelatedGroupIds" resultType="string">
        SELECT group_id
        FROM scheduler_related_group_user
        WHERE user_id = #{userId}
    </select>

</mapper>
