<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tes.batch.scheduler.domain.job.mapper.JobMapper">

    <!-- Result Map -->
    <resultMap id="JobResultMap" type="com.tes.batch.scheduler.domain.job.vo.JobVO">
        <id property="jobId" column="job_id"/>
        <result property="jobName" column="job_name"/>
        <result property="systemId" column="system_id"/>
        <result property="groupId" column="group_id"/>
        <result property="jobType" column="job_type"/>
        <result property="jobAction" column="job_action"/>
        <result property="jobBody" column="job_body"/>
        <result property="jobComments" column="job_comments"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="repeatInterval" column="repeat_interval"/>
        <result property="timezone" column="timezone"/>
        <result property="maxRun" column="max_run"/>
        <result property="maxFailure" column="max_failure"/>
        <result property="maxRunDuration" column="max_run_duration"/>
        <result property="retryDelay" column="retry_delay"/>
        <result property="priority" column="priority"/>
        <result property="isEnabled" column="is_enabled"/>
        <result property="currentState" column="current_state"/>
        <result property="nextRunDate" column="next_run_date"/>
        <result property="lastStartDate" column="last_start_date"/>
        <result property="runCount" column="run_count"/>
        <result property="failureCount" column="failure_count"/>
        <result property="retryCount" column="retry_count"/>
        <result property="autoDrop" column="auto_drop"/>
        <result property="restartOnFailure" column="restart_on_failure"/>
        <result property="restartable" column="restartable"/>
        <result property="ignoreResult" column="ignore_result"/>
        <result property="runForever" column="run_forever"/>
        <result property="workflowId" column="workflow_id"/>
        <result property="priorityGroupId" column="priority_group_id"/>
        <result property="workflowDelay" column="workflow_delay"/>
        <result property="frstRegDate" column="frst_reg_date"/>
        <result property="lastChgDate" column="last_chg_date"/>
        <result property="frstRegUserId" column="frst_reg_user_id"/>
        <result property="lastRegUserId" column="last_reg_user_id"/>
        <result property="systemName" column="system_name"/>
        <result property="groupName" column="group_name"/>
        <result property="creator" column="creator"/>
        <result property="lastResult" column="last_result"/>
        <result property="duration" column="duration"/>
    </resultMap>

    <!-- Base Column List -->
    <sql id="BaseColumns">
        j.job_id, j.job_name, j.system_id, j.group_id, j.job_type, j.job_action,
        j.job_body, j.job_comments, j.start_date, j.end_date, j.repeat_interval,
        j.timezone, j.max_run, j.max_failure, j.max_run_duration, j.retry_delay,
        j.priority, j.is_enabled, j.current_state, j.next_run_date, j.last_start_date,
        j.run_count, j.failure_count, j.retry_count, j.auto_drop, j.restart_on_failure,
        j.restartable, j.ignore_result, j.run_forever, j.workflow_id, j.priority_group_id,
        j.workflow_delay, j.frst_reg_date, j.last_chg_date, j.frst_reg_user_id, j.last_reg_user_id
    </sql>

    <!-- Find by ID -->
    <select id="findById" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_jobs j
        WHERE j.job_id = #{jobId}
    </select>

    <!-- Find by ID with Relations -->
    <select id="findByIdWithRelations" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>,
               s.system_name, g.group_name
        FROM scheduler_jobs j
        LEFT JOIN scheduler_job_servers s ON j.system_id = s.system_id
        LEFT JOIN scheduler_job_groups g ON j.group_id = g.group_id
        WHERE j.job_id = #{jobId}
    </select>

    <!-- Find by Job Name -->
    <select id="findByJobName" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_jobs j
        WHERE j.job_name = #{jobName}
    </select>

    <!-- Check if Job Name exists -->
    <select id="existsByJobName" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM scheduler_jobs WHERE job_name = #{jobName}
        )
    </select>

    <!-- Find Jobs by Workflow ID -->
    <select id="findByWorkflowId" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_jobs j
        WHERE j.workflow_id = #{workflowId}
        ORDER BY j.priority ASC
    </select>

    <!-- Find Jobs by Priority Group ID -->
    <select id="findByPriorityGroupId" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_jobs j
        WHERE j.priority_group_id = #{priorityGroupId}
        ORDER BY j.priority ASC
    </select>

    <!-- Find Jobs to Execute (for polling - kept for compatibility) -->
    <select id="findJobsToExecute" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_jobs j
        WHERE j.is_enabled = true
          AND j.next_run_date IS NOT NULL
          AND j.next_run_date &lt;= #{now}
    </select>

    <!-- Find Enabled Jobs with Schedule (for Quartz initialization) -->
    <select id="findEnabledJobsWithSchedule" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_jobs j
        WHERE j.is_enabled = true
          AND j.repeat_interval IS NOT NULL
          AND j.repeat_interval != ''
    </select>

    <!-- Find Jobs with Filters -->
    <select id="findByFilters" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>,
               s.system_name, g.group_name,
               u.user_name as creator,
               rl.status as last_result,
               rl.duration as duration
        FROM scheduler_jobs j
        LEFT JOIN scheduler_job_servers s ON j.system_id = s.system_id
        LEFT JOIN scheduler_job_groups g ON j.group_id = g.group_id
        LEFT JOIN scheduler_users u ON j.frst_reg_user_id = u.id
        LEFT JOIN LATERAL (
            SELECT log_id, status, duration FROM scheduler_job_run_logs
            WHERE job_id = j.job_id ORDER BY log_id DESC LIMIT 1
        ) rl ON true
        <where>
            <if test="jobId != null and jobId != ''">
                AND j.job_id = #{jobId}
            </if>
            <if test="groupId != null and groupId != ''">
                AND j.group_id = #{groupId}
            </if>
            <if test="systemId != null and systemId != ''">
                AND j.system_id = #{systemId}
            </if>
            <if test="isEnabled != null">
                AND j.is_enabled = #{isEnabled}
            </if>
            <if test="currentState != null and currentState != ''">
                AND j.current_state = #{currentState}
            </if>
            <if test="textSearch != null and textSearch != ''">
                AND (
                    LOWER(j.job_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                    OR LOWER(j.job_comments) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                )
            </if>
            <if test="wfRegistered != null">
                <if test="wfRegistered == true">
                    AND j.workflow_id IS NOT NULL
                </if>
                <if test="wfRegistered == false">
                    AND j.workflow_id IS NULL
                </if>
            </if>
            <if test="lastStartDateFrom != null">
                AND j.last_start_date &gt;= #{lastStartDateFrom}
            </if>
            <if test="lastStartDateTo != null">
                AND j.last_start_date &lt;= #{lastStartDateTo}
            </if>
        </where>
        ORDER BY j.job_name ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count Jobs with Filters -->
    <select id="countByFilters" resultType="long">
        SELECT COUNT(*)
        FROM scheduler_jobs j
        <where>
            <if test="jobId != null and jobId != ''">
                AND j.job_id = #{jobId}
            </if>
            <if test="groupId != null and groupId != ''">
                AND j.group_id = #{groupId}
            </if>
            <if test="systemId != null and systemId != ''">
                AND j.system_id = #{systemId}
            </if>
            <if test="isEnabled != null">
                AND j.is_enabled = #{isEnabled}
            </if>
            <if test="currentState != null and currentState != ''">
                AND j.current_state = #{currentState}
            </if>
            <if test="textSearch != null and textSearch != ''">
                AND (
                    LOWER(j.job_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                    OR LOWER(j.job_comments) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                )
            </if>
            <if test="wfRegistered != null">
                <if test="wfRegistered == true">
                    AND j.workflow_id IS NOT NULL
                </if>
                <if test="wfRegistered == false">
                    AND j.workflow_id IS NULL
                </if>
            </if>
            <if test="lastStartDateFrom != null">
                AND j.last_start_date &gt;= #{lastStartDateFrom}
            </if>
            <if test="lastStartDateTo != null">
                AND j.last_start_date &lt;= #{lastStartDateTo}
            </if>
        </where>
    </select>

    <!-- Find Jobs by Filters and Group IDs -->
    <select id="findByFiltersAndGroupIds" resultMap="JobResultMap">
        SELECT <include refid="BaseColumns"/>,
               s.system_name, g.group_name,
               u.user_name as creator,
               rl.status as last_result,
               rl.duration as duration
        FROM scheduler_jobs j
        LEFT JOIN scheduler_job_servers s ON j.system_id = s.system_id
        LEFT JOIN scheduler_job_groups g ON j.group_id = g.group_id
        LEFT JOIN scheduler_users u ON j.frst_reg_user_id = u.id
        LEFT JOIN LATERAL (
            SELECT log_id, status, duration FROM scheduler_job_run_logs
            WHERE job_id = j.job_id ORDER BY log_id DESC LIMIT 1
        ) rl ON true
        WHERE j.group_id IN
        <foreach collection="groupIds" item="gid" open="(" separator="," close=")">
            #{gid}
        </foreach>
        <if test="jobId != null and jobId != ''">
            AND j.job_id = #{jobId}
        </if>
        <if test="systemId != null and systemId != ''">
            AND j.system_id = #{systemId}
        </if>
        <if test="isEnabled != null">
            AND j.is_enabled = #{isEnabled}
        </if>
        <if test="currentState != null and currentState != ''">
            AND j.current_state = #{currentState}
        </if>
        <if test="textSearch != null and textSearch != ''">
            AND (
                LOWER(j.job_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                OR LOWER(j.job_comments) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
            )
        </if>
        ORDER BY j.job_name ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count Jobs by Filters and Group IDs -->
    <select id="countByFiltersAndGroupIds" resultType="long">
        SELECT COUNT(*)
        FROM scheduler_jobs j
        WHERE j.group_id IN
        <foreach collection="groupIds" item="gid" open="(" separator="," close=")">
            #{gid}
        </foreach>
        <if test="jobId != null and jobId != ''">
            AND j.job_id = #{jobId}
        </if>
        <if test="systemId != null and systemId != ''">
            AND j.system_id = #{systemId}
        </if>
        <if test="isEnabled != null">
            AND j.is_enabled = #{isEnabled}
        </if>
        <if test="currentState != null and currentState != ''">
            AND j.current_state = #{currentState}
        </if>
        <if test="textSearch != null and textSearch != ''">
            AND (
                LOWER(j.job_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                OR LOWER(j.job_comments) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
            )
        </if>
    </select>

    <!-- Insert Job -->
    <insert id="insert">
        INSERT INTO scheduler_jobs (
            job_id, job_name, system_id, group_id, job_type, job_action,
            job_body, job_comments, start_date, end_date, repeat_interval,
            timezone, max_run, max_failure, max_run_duration, retry_delay,
            priority, is_enabled, current_state, next_run_date, last_start_date,
            run_count, failure_count, retry_count, auto_drop, restart_on_failure,
            restartable, ignore_result, run_forever, workflow_id, priority_group_id,
            workflow_delay, frst_reg_date, last_chg_date, frst_reg_user_id, last_reg_user_id
        ) VALUES (
            #{jobId}, #{jobName}, #{systemId}, #{groupId}, #{jobType}, #{jobAction},
            #{jobBody}, #{jobComments}, #{startDate}, #{endDate}, #{repeatInterval},
            #{timezone}, #{maxRun}, #{maxFailure}, #{maxRunDuration}, #{retryDelay},
            #{priority}, #{isEnabled}, #{currentState}, #{nextRunDate}, #{lastStartDate},
            #{runCount}, #{failureCount}, #{retryCount}, #{autoDrop}, #{restartOnFailure},
            #{restartable}, #{ignoreResult}, #{runForever}, #{workflowId}, #{priorityGroupId},
            #{workflowDelay}, #{frstRegDate}, #{lastChgDate}, #{frstRegUserId}, #{lastRegUserId}
        )
    </insert>

    <!-- Update Job -->
    <update id="update">
        UPDATE scheduler_jobs
        SET job_name = #{jobName},
            system_id = #{systemId},
            group_id = #{groupId},
            job_type = #{jobType},
            job_action = #{jobAction},
            job_body = #{jobBody},
            job_comments = #{jobComments},
            start_date = #{startDate},
            end_date = #{endDate},
            repeat_interval = #{repeatInterval},
            timezone = #{timezone},
            max_run = #{maxRun},
            max_failure = #{maxFailure},
            max_run_duration = #{maxRunDuration},
            retry_delay = #{retryDelay},
            priority = #{priority},
            is_enabled = #{isEnabled},
            current_state = #{currentState},
            next_run_date = #{nextRunDate},
            auto_drop = #{autoDrop},
            restart_on_failure = #{restartOnFailure},
            restartable = #{restartable},
            ignore_result = #{ignoreResult},
            run_forever = #{runForever},
            workflow_id = #{workflowId},
            priority_group_id = #{priorityGroupId},
            workflow_delay = #{workflowDelay},
            last_chg_date = #{lastChgDate},
            last_reg_user_id = #{lastRegUserId}
        WHERE job_id = #{jobId}
    </update>

    <!-- Update Job State -->
    <update id="updateState">
        UPDATE scheduler_jobs
        SET current_state = #{currentState},
            next_run_date = #{nextRunDate}
        WHERE job_id = #{jobId}
    </update>

    <!-- Update Job State with Last Start Date -->
    <update id="updateStateWithLastStart">
        UPDATE scheduler_jobs
        SET current_state = #{currentState},
            next_run_date = #{nextRunDate},
            last_start_date = #{lastStartDate}
        WHERE job_id = #{jobId}
    </update>

    <!-- Update Run Stats -->
    <update id="updateRunStats">
        UPDATE scheduler_jobs
        SET <if test="lastStartDate != null">last_start_date = #{lastStartDate},</if>
            run_count = #{runCount},
            failure_count = #{failureCount},
            retry_count = #{retryCount}
        WHERE job_id = #{jobId}
    </update>

    <!-- Delete Job -->
    <delete id="delete">
        DELETE FROM scheduler_jobs WHERE job_id = #{jobId}
    </delete>

    <!-- Delete Jobs by Workflow ID -->
    <delete id="deleteByWorkflowId">
        DELETE FROM scheduler_jobs WHERE workflow_id = #{workflowId}
    </delete>

    <!-- Update Workflow Info -->
    <update id="updateWorkflowInfo">
        UPDATE scheduler_jobs
        SET workflow_id = #{workflowId},
            priority_group_id = #{priorityGroupId},
            workflow_delay = #{workflowDelay}
        WHERE job_id = #{jobId}
    </update>

    <!-- Clear Workflow Info by Priority Group ID -->
    <update id="clearWorkflowInfo">
        UPDATE scheduler_jobs
        SET workflow_id = NULL,
            priority_group_id = NULL,
            workflow_delay = NULL
        WHERE priority_group_id = #{priorityGroupId}
    </update>

</mapper>
