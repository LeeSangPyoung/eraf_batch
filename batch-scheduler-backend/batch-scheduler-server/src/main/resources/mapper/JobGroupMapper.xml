<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tes.batch.scheduler.domain.group.mapper.JobGroupMapper">

    <!-- Result Map -->
    <resultMap id="JobGroupResultMap" type="com.tes.batch.scheduler.domain.group.vo.JobGroupVO">
        <id property="groupId" column="group_id"/>
        <result property="groupName" column="group_name"/>
        <result property="groupComments" column="group_description"/>
        <result property="frstRegDate" column="frst_reg_date"/>
        <result property="lastChgDate" column="last_chg_date"/>
        <result property="frstRegUserId" column="frst_reg_user_id"/>
        <result property="lastRegUserId" column="last_reg_user_id"/>
        <result property="creator" column="creator"/>
        <result property="lastModifier" column="last_modifier"/>
        <result property="jobCount" column="job_count"/>
        <result property="userCount" column="user_count"/>
    </resultMap>

    <!-- Base Column List -->
    <sql id="BaseColumns">
        group_id, group_name, group_description, frst_reg_date, last_chg_date, frst_reg_user_id, last_reg_user_id
    </sql>

    <!-- Find by ID -->
    <select id="findById" resultMap="JobGroupResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_job_groups
        WHERE group_id = #{groupId}
    </select>

    <!-- Find by Group Name -->
    <select id="findByGroupName" resultMap="JobGroupResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_job_groups
        WHERE group_name = #{groupName}
    </select>

    <!-- Check if Group Name exists -->
    <select id="existsByGroupName" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM scheduler_job_groups WHERE group_name = #{groupName}
        )
    </select>

    <!-- Find All Groups -->
    <select id="findAll" resultMap="JobGroupResultMap">
        SELECT g.group_id, g.group_name, g.group_description, g.frst_reg_date, g.last_chg_date,
               g.frst_reg_user_id, g.last_reg_user_id,
               u1.user_name as creator,
               u2.user_name as last_modifier
        FROM scheduler_job_groups g
        LEFT JOIN scheduler_users u1 ON g.frst_reg_user_id = u1.id
        LEFT JOIN scheduler_users u2 ON g.last_reg_user_id = u2.id
        ORDER BY g.group_name ASC
    </select>

    <!-- Find Groups by IDs -->
    <select id="findByGroupIdIn" resultMap="JobGroupResultMap">
        SELECT g.group_id, g.group_name, g.group_description, g.frst_reg_date, g.last_chg_date,
               g.frst_reg_user_id, g.last_reg_user_id,
               u1.user_name as creator,
               u2.user_name as last_modifier
        FROM scheduler_job_groups g
        LEFT JOIN scheduler_users u1 ON g.frst_reg_user_id = u1.id
        LEFT JOIN scheduler_users u2 ON g.last_reg_user_id = u2.id
        WHERE g.group_id IN
        <foreach collection="groupIds" item="groupId" open="(" separator="," close=")">
            #{groupId}
        </foreach>
        ORDER BY g.group_name ASC
    </select>

    <!-- Find Groups with Filters -->
    <select id="findByFilters" resultMap="JobGroupResultMap">
        SELECT g.group_id, g.group_name, g.group_description, g.frst_reg_date, g.last_chg_date,
               g.frst_reg_user_id, g.last_reg_user_id,
               u1.user_name as creator,
               u2.user_name as last_modifier,
               (SELECT COUNT(*) FROM scheduler_jobs j WHERE j.group_id = g.group_id) as job_count,
               (SELECT COUNT(*) FROM scheduler_related_group_user ug WHERE ug.group_id = g.group_id) as user_count
        FROM scheduler_job_groups g
        LEFT JOIN scheduler_users u1 ON g.frst_reg_user_id = u1.id
        LEFT JOIN scheduler_users u2 ON g.last_reg_user_id = u2.id
        <where>
            <if test="textSearch != null and textSearch != ''">
                AND (
                    LOWER(g.group_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%')) ESCAPE '\'
                    OR LOWER(g.group_description) LIKE LOWER(CONCAT('%', #{textSearch}, '%')) ESCAPE '\'
                )
            </if>
        </where>
        ORDER BY g.group_name ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count Groups with Filters -->
    <select id="countByFilters" resultType="long">
        SELECT COUNT(*)
        FROM scheduler_job_groups
        <where>
            <if test="textSearch != null and textSearch != ''">
                AND (
                    LOWER(group_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%')) ESCAPE '\'
                    OR LOWER(group_description) LIKE LOWER(CONCAT('%', #{textSearch}, '%')) ESCAPE '\'
                )
            </if>
        </where>
    </select>

    <!-- Find Groups by IDs with Paging -->
    <select id="findByGroupIdInWithPaging" resultMap="JobGroupResultMap">
        SELECT g.group_id, g.group_name, g.group_description, g.frst_reg_date, g.last_chg_date,
               g.frst_reg_user_id, g.last_reg_user_id,
               u1.user_name as creator,
               u2.user_name as last_modifier
        FROM scheduler_job_groups g
        LEFT JOIN scheduler_users u1 ON g.frst_reg_user_id = u1.id
        LEFT JOIN scheduler_users u2 ON g.last_reg_user_id = u2.id
        WHERE g.group_id IN
        <foreach collection="groupIds" item="groupId" open="(" separator="," close=")">
            #{groupId}
        </foreach>
        ORDER BY g.group_name ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count Groups by IDs -->
    <select id="countByGroupIdIn" resultType="long">
        SELECT COUNT(*)
        FROM scheduler_job_groups
        WHERE group_id IN
        <foreach collection="groupIds" item="groupId" open="(" separator="," close=")">
            #{groupId}
        </foreach>
    </select>

    <!-- Insert Group -->
    <insert id="insert">
        INSERT INTO scheduler_job_groups (
            group_id, group_name, group_description, frst_reg_date, last_chg_date, frst_reg_user_id, last_reg_user_id
        ) VALUES (
            #{groupId}, #{groupName}, #{groupComments}, #{frstRegDate}, #{lastChgDate}, #{frstRegUserId}, #{lastRegUserId}
        )
    </insert>

    <!-- Update Group -->
    <update id="update">
        UPDATE scheduler_job_groups
        SET group_name = #{groupName},
            group_description = #{groupComments},
            last_chg_date = #{lastChgDate},
            last_reg_user_id = #{lastRegUserId}
        WHERE group_id = #{groupId}
    </update>

    <!-- Delete Group -->
    <delete id="delete">
        DELETE FROM scheduler_job_groups WHERE group_id = #{groupId}
    </delete>

</mapper>
