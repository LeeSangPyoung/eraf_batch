<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tes.batch.scheduler.domain.server.mapper.JobServerMapper">

    <!-- Result Map -->
    <resultMap id="JobServerResultMap" type="com.tes.batch.scheduler.domain.server.vo.JobServerVO">
        <id property="systemId" column="system_id"/>
        <result property="systemName" column="system_name"/>
        <result property="hostName" column="host_name"/>
        <result property="hostIpAddr" column="host_ip_addr"/>
        <result property="systemComments" column="system_comments"/>
        <result property="queueName" column="queue_name"/>
        <result property="folderPath" column="folder_path"/>
        <result property="sshUser" column="ssh_user"/>
        <result property="sshPassword" column="ssh_password"/>
        <result property="agentStatus" column="agent_status"/>
        <result property="isHealthy" column="is_healthy"/>
        <result property="agentPort" column="agent_port"/>
        <result property="deploymentType" column="deployment_type" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="mountPaths" column="mount_paths"/>
        <result property="frstRegDate" column="frst_reg_date"/>
        <result property="lastChgDate" column="last_chg_date"/>
        <result property="frstRegUserId" column="frst_reg_user_id"/>
        <result property="lastRegUserId" column="last_reg_user_id"/>
        <result property="creator" column="creator"/>
        <result property="lastModifier" column="last_modifier"/>
    </resultMap>

    <!-- Base Column List -->
    <sql id="BaseColumns">
        system_id, system_name, host_name, host_ip_addr,
        system_comments, queue_name, folder_path, ssh_user, ssh_password,
        agent_status, is_healthy, agent_port, deployment_type, mount_paths, frst_reg_date, last_chg_date, frst_reg_user_id, last_reg_user_id
    </sql>

    <!-- Find by ID -->
    <select id="findById" resultMap="JobServerResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_job_servers
        WHERE system_id = #{systemId}
    </select>

    <!-- Find by System Name -->
    <select id="findBySystemName" resultMap="JobServerResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_job_servers
        WHERE system_name = #{systemName}
    </select>

    <!-- Find by Queue Name -->
    <select id="findByQueueName" resultMap="JobServerResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_job_servers
        WHERE queue_name = #{queueName}
    </select>

    <!-- Check if System Name exists -->
    <select id="existsBySystemName" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM scheduler_job_servers WHERE system_name = #{systemName}
        )
    </select>

    <!-- Find By Host and Port -->
    <select id="findByHostAndPort" resultMap="JobServerResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_job_servers
        WHERE host_ip_addr = #{hostIpAddr}
        AND agent_port = #{agentPort}
    </select>

    <!-- Find All Servers -->
    <select id="findAll" resultMap="JobServerResultMap">
        SELECT s.system_id, s.system_name, s.host_name, s.host_ip_addr,
               s.system_comments, s.queue_name, s.folder_path, s.ssh_user, s.ssh_password,
               s.agent_status, s.is_healthy, s.agent_port, s.deployment_type, s.mount_paths,
               s.frst_reg_date, s.last_chg_date, s.frst_reg_user_id, s.last_reg_user_id,
               u1.user_name as creator,
               u2.user_name as last_modifier
        FROM scheduler_job_servers s
        LEFT JOIN scheduler_users u1 ON s.frst_reg_user_id = u1.id
        LEFT JOIN scheduler_users u2 ON s.last_reg_user_id = u2.id
        ORDER BY s.system_name ASC
    </select>

    <!-- Find Servers with Filters -->
    <select id="findByFilters" resultMap="JobServerResultMap">
        SELECT s.system_id, s.system_name, s.host_name, s.host_ip_addr,
               s.system_comments, s.queue_name, s.folder_path, s.ssh_user, s.ssh_password,
               s.agent_status, s.is_healthy, s.agent_port, s.deployment_type, s.mount_paths,
               s.frst_reg_date, s.last_chg_date, s.frst_reg_user_id, s.last_reg_user_id,
               u1.user_name as creator,
               u2.user_name as last_modifier
        FROM scheduler_job_servers s
        LEFT JOIN scheduler_users u1 ON s.frst_reg_user_id = u1.id
        LEFT JOIN scheduler_users u2 ON s.last_reg_user_id = u2.id
        <where>
            <if test="textSearch != null and textSearch != ''">
                AND (
                    LOWER(s.system_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                    OR LOWER(s.host_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                    OR LOWER(s.host_ip_addr) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                )
            </if>
        </where>
        ORDER BY s.system_name ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Count Servers with Filters -->
    <select id="countByFilters" resultType="long">
        SELECT COUNT(*)
        FROM scheduler_job_servers
        <where>
            <if test="textSearch != null and textSearch != ''">
                AND (
                    LOWER(system_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                    OR LOWER(host_name) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                    OR LOWER(host_ip_addr) LIKE LOWER(CONCAT('%', #{textSearch}, '%'))
                )
            </if>
        </where>
    </select>

    <!-- Find Servers by Agent Status -->
    <select id="findByAgentStatus" resultMap="JobServerResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM scheduler_job_servers
        WHERE agent_status = #{status}
        ORDER BY system_name ASC
    </select>

    <!-- Insert Server -->
    <insert id="insert">
        INSERT INTO scheduler_job_servers (
            system_id, system_name, host_name, host_ip_addr,
            system_comments, queue_name, folder_path, ssh_user, ssh_password,
            agent_status, is_healthy, agent_port, deployment_type, mount_paths,
            frst_reg_date, last_chg_date, frst_reg_user_id, last_reg_user_id
        ) VALUES (
            #{systemId}, #{systemName}, #{hostName}, #{hostIpAddr},
            #{systemComments}, #{queueName}, #{folderPath}, #{sshUser}, #{sshPassword},
            #{agentStatus}, #{isHealthy}, #{agentPort}, #{deploymentType, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, #{mountPaths},
            #{frstRegDate}, #{lastChgDate}, #{frstRegUserId}, #{lastRegUserId}
        )
    </insert>

    <!-- Update Server -->
    <update id="update">
        UPDATE scheduler_job_servers
        SET system_name = #{systemName},
            host_name = #{hostName},
            host_ip_addr = #{hostIpAddr},
            system_comments = #{systemComments},
            folder_path = #{folderPath},
            ssh_user = #{sshUser},
            ssh_password = #{sshPassword},
            agent_port = #{agentPort},
            deployment_type = #{deploymentType, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            mount_paths = #{mountPaths},
            last_chg_date = #{lastChgDate},
            last_reg_user_id = #{lastRegUserId}
        WHERE system_id = #{systemId}
    </update>

    <!-- Update Agent Status -->
    <update id="updateAgentStatus">
        UPDATE scheduler_job_servers
        SET agent_status = #{agentStatus}
        WHERE system_id = #{systemId}
    </update>

    <!-- Update Health Status (set by heartbeat checker) -->
    <update id="updateHealthStatus">
        UPDATE scheduler_job_servers
        SET is_healthy = #{isHealthy}
        WHERE system_id = #{systemId}
    </update>

    <!-- Delete Server -->
    <delete id="delete">
        DELETE FROM scheduler_job_servers WHERE system_id = #{systemId}
    </delete>

</mapper>
